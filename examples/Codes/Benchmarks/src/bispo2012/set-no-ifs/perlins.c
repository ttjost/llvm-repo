/* 3D Bilinear texture mapping */
/* Source: ftp://download.intel.com/ids/mmx/MMX_App_Procedural_Texturing.pdf */
/* pp. 18--20 */
/* Código para usar no apêndice B do artigo indicado acima */


#define random1(i) ((i * i) & 65535)
#define random2(i) (((i * i) & 65535) >> 2)

#define _int16 short


#define NUM_PIXEIS 1024

// Seed 2
unsigned _int16 palette[NUM_PIXEIS] = {
    29241, -17928, 17808, 24343, -15382, 24269, 28252, 25422, 31503, -6791, -25444, 24765,
    -28940, -31508, -20444, -12224, -27209, -1762, -7291, -4514, -18644, -14817, 21390, 1653,
    27137, 6253, -1259, -17097, 24354, -10619, 9975, 3668, 16222, -18500, -22948, -3720,
    8010, 29774, 15167, -9608, -12955, 25271, 3885, -30521, 24188, 5697, 12364, -9682,
    -25520, -11554, 23198, -27460, 14965, -5577, -28281, 23546, -2692, 22020, 19852, 17763,
    84, 9117, 16989, -16366, 25581, -31535, 277, -15427, 13597, -26122, -1345, 31457,
    -15161, 18753, -22757, -9154, 11833, -18601, -11358, -6266, -6186, 13603, 24264, 31056,
    14836, -18710, -7296, -5550, -16377, 10396, 6405, -4657, 22526, 13163, -5418, 25422,
    9197, 18593, -29439, 3980, -32277, 1454, 4260, 28851, 7741, 17792, 15536, 8651,
    -31821, 29463, -20752, -32401, -12718, -3752, -30391, -28732, 25650, -21472, 12099, 14247,
    -10071, 9883, -10297, 30501, 23977, -25897, -2262, 6959, 26470, -365, -14998, 654,
    26171, 349, 25782, 7188, -17714, 22491, 27699, -27629, 18545, -6040, -9475, -6893,
    18891, -21278, -18581, -16450, 19383, 24001, -8554, -481, 29291, 14956, -14308, 5643,
    27869, -32057, 16929, -16673, -17823, 30224, 27030, -16789, 9878, -5397, 25277, 4397,
    -24701, -11078, -27156, -7743, -13828, 18994, 29840, 920, -1974, -7893, 2676, -6936,
    26378, 29622, -8381, 11235, -7083, -23948, -5045, 29482, 17697, -22491, -21885, -9852,
    19686, 21119, 31951, 22730, -5244, 13376, -1407, 6182, -2717, 25734, -8669, 11644,
    -17957, 24414, -25485, -32217, 7126, -9318, -6226, -12568, 4276, -22042, -23791, -7398,
    -22162, -3811, 2716, -21718, 2557, 23512, 4889, -21945, -3332, 2888, 18012, -9387,
    -15988, 25413, -24629, 11558, 2423, 934, 11552, 3563, 11671, -32045, 30573, -17944,
    -25992, -17001, -1952, 16742, -30916, -12230, 8136, 31214, 24767, 3278, -21161, 20147,
    17146, -32055, 25257, 9295, 9388, -5164, 20868, 17330, -26314, 4577, 19041, -32681,
    19654, 643, 12075, -29257, -24904, -23687, 11846, -18430, -456, 31883, 10706, -3060,
    -4821, -13671, -12496, 31365, -12977, 12272, 8900, 25197, -9312, -27169, -31748, -4410,
    -515, 5001, 28049, -31862, 18187, -4611, 30221, 30175, 21593, 1411, 21644, 11144,
    -5435, 17464, -4666, 15775, 29981, -7715, -21172, -28031, 18696, -28437, -20719, -23800,
    -10713, -5910, 32043, 24319, 9079, -24062, 26075, 25810, 16120, 30162, -21046, -32635,
    -31853, -18048, 8853, -23065, -9928, 1296, -11893, -9722, 21318, 31737, -6475, -16411,
    -11984, -29963, -2026, -17300, -31396, 12056, 16691, -6753, -31154, 6692, -27947, 12562,
    -12795, 18458, -1268, -27236, 19365, -9708, 26999, 5195, -5291, 19026, -11325, -9065,
    -18326, 19857, -24976, -39, 32197, -2653, 19931, 26621, -30600, -5828, -15496, 1398,
    28847, -15095, -29858, 26738, 3277, -1530, -504, 14670, -3371, -17136, 14937, 17484,
    11275, -9287, 15328, 3203, -294, -30117, -28323, 6678, -3336, 32623, 30596, 30632,
    29639, -4065, 23552, 4879, -19202, 16921, 3258, -2745, -17016, -31067, 5978, -31320,
    -17236, 4857, 7437, 19547, 3437, -13877, 7817, -6134, -29646, -5592, 1101, 10966,
    8874, 30596, -6355, -28018, -21015, -28911, -8947, -28643, -23850, 15955, 19948, 21058,
    5321, -20748, 5412, 1927, 624, -17452, -3345, -13461, 3314, 17252, 4653, -19743,
    -683, -13516, -22941, -21507, -17372, 18633, -6650, 9452, -24757, 9140, -6918, -20955,
    12870, -15137, 4949, 3038, -9094, 18217, 25703, 27328, 2530, 7477, 25086, -21539,
    -17938, -16257, -20507, -1055, -26457, -16977, -15442, 10631, 1558, -19919, -11087, 28495,
    -20506, 3845, 18516, -23443, -24248, -19245, 7819, 2308, -4842, -17086, 8866, 8595,
    22075, 1417, -7110, 21935, -26031, 20037, -17264, 17906, 17035, 1165, 25605, 3379,
    7892, 2115, -9254, -7945, -12488, 941, -20422, -15066, -125, 10307, -10627, 18177,
    14631, 25802, -21590, 29523, 28514, 26785, -10434, 31718, -22112, 2138, 5675, -16328,
    28701, -10357, 12835, 11631, -8498, 3046, -22251, 10633, -32127, -633, -14089, 32215,
    25666, -10099, 17350, -2901, -6399, 21483, 32714, -25008, 23409, -32385, 10270, -3782,
    28210, 2916, -16017, 14718, -11215, 29316, 18179, 2947, -9905, 8816, 5117, -20999,
    -19136, 28275, -25377, -20726, -13643, -13341, -17073, 6352, 13501, -8773, -25059, -1786,
    18024, 9574, 30596, 12289, -8019, 27869, -19537, -17696, -15731, 15859, 13695, -4862,
    14199, -1297, -14453, 19640, -14354, 27739, -2201, 1851, -12184, -10213, -7895, 12256,
    8825, -2624, -20695, 16009, 5169, 21534, -11769, -32417, -24127, 1051, 13553, 30141,
    -31388, -25399, -3547, 15471, 27003, -4937, 19381, -25317, -26374, -4989, -4983, 19711,
    -11773, -14668, -19030, 27868, 7887, 2246, -25667, 29233, -10027, 20869, 22732, -4180,
    14884, 4254, -2484, -3875, 8468, 11122, 29531, -8916, -5603, -25811, 2888, 5645,
    -31738, 22551, -8104, -15247, 8769, 9769, 3783, -30337, 12693, 5859, 27661, 1667,
    29437, -11172, 30305, 28710, 24784, 2458, 14466, -24353, 16929, 31779, 9652, 24233,
    -28568, -21804, 12808, -14346, -27807, 1520, -21791, 7139, 22323, 5243, -27726, 20908,
    24789, 6857, -29940, 13153, -15187, 5713, 31703, -4135, -31879, 8902, -24865, 22503,
    20850, -25496, -28526, 15051, 11182, -27754, 32519, -27157, 24517, 26024, -19390, -29757,
    -5705, -28933, 182, 22040, 19469, 2636, -13814, -22669, 17981, -11959, -15840, 12237,
    3410, 21093, -30126, 14470, -5428, -4117, -14594, -29796, 26052, -9130, 26436, 6680,
    23124, -6177, 9486, 5579, -23755, 4950, -32432, 29242, 14760, -971, -16240, 214,
    -4198, 30193, -21592, -25488, 10242, -7021, 6346, 6123, 12685, 11399, -32571, -7118,
    10109, 19380, 9350, -24212, 31950, -4148, -31008, 3950, -27238, -25116, 16015, 4465,
    4797, 16198, 25722, -18172, -19524, 10118, 8759, -29629, -3358, -6189, 9428, 31561,
    -16468, -31858, -2092, 14562, -1178, -9696, -29577, -5499, -25579, 23048, 28991, 25473,
    -26217, 20786, 32174, 24437, 2312, 28303, -2477, 28676, 2664, 18657, 27911, -28215,
    27770, -298, -7820, -25463, 10990, 17496, -6698, 679, 10946, 28963, -13307, -27684,
    -10012, 25751, 7858, 14118, -28901, 21199, -5392, -12287, -7384, -12559, -25098, -15660,
    17448, -22841, 31523, -13138, -30148, 25486, -4543, 8753, 23659, -31730, 15885, 2510,
    -28474, -15382, 25335, 25906, -5428, 1081, 1573, -8705, -9200, -22188, -4931, -22081,
    11032, -32271, 21347, 6421, -23416, -29840, -512, 26164, 14976, 10101, -59, 30357,
    13889, -26954, 32623, -31772, 24598, -13035, -1076, -8134, 16753, -3344, -11139, 18833,
    -6829, 10168, 6908, -32652, -17679, 22976, -4128, 5622, 32404, 18263, -4000, -23324,
    19648, -744, 30741, -5571, 17304, 25983, -17661, 28898, 22144, -16960, -1063, -15223,
    14340, 979, 25208, 24567, 32247, -20013, 14001, -13714, 25567, 23176, -31918, -26525,
    -12400, -1214, 25955, 17268, 31766, 5864, -29779, 3480, 28376, -4529, -21893, 25495,
    6905, 27087, -6236, 29373, -10495, -30700, -32057, -6710, -30532, 26161, 15832, -724,
    -21662, 13562, 18908, 30319, 5111, -20590, -17424, -2316, 6132, -6334, -12657, -4640,
    -1497, 30860, 29459, 8535, -15913, 32127, -2180, 23274, -8149, -11955, -15249, -6323,
    18379, 31002, 30594, -8883, -9529, 17942, -8778, 24576, 21176, 1229, -28092, 20541,
    1828, -12867, 17820, 8526, 13862, 19241, -3926, -15132, -19634, 2092, 30810, -7606,
    8389, 7440, -31394, -13091, 5813, -13088, -27602, -4676, -8985, -6085, -32432, -27461,
    -25940, 2410, 5593, 25756, 8449, -587, 22578, -12672, -19731, -4111, -23265, 20634,
    28718, 10333, -11011, 27686, 17940, 30127, -3765, -31079, -30037, -27799, 15979, 10778,
    -23009, 8560, -25176, 22832
};





// output
unsigned _int16 screen_buffer[NUM_PIXEIS];


//***********************************************************************
//Procedure C_Noise()
//Inputs: u_init, v_init: starting u and v parameters into the image.
// du, dv: the incremental change to u_init and v_init.
// ddu, ddv: the incremental change to du and dv.
// Num_Pix: number of pixels in the scan line to draw.
// screen_buffer: Pointer to the screen buffer.
//Output: 16 bit pixels are drawn to the screen.
//***********************************************************************

void C_Noise(long u_init, long v_init, long du, long dv, long ddu, long ddv,
             unsigned _int16 Num_Pix, unsigned _int16* palette,
             unsigned _int16* screen_buffer)
{
  unsigned char color;
  unsigned char bx0, bx1, by0, by1;
  unsigned char rx0, ry0;

  _int16 g_b00_0;
  _int16 g_b00_1;
  _int16 g_b01_0;
  _int16 g_b01_1;
  _int16 g_b10_0;
  _int16 g_b10_1;
  _int16 g_b11_0;
  _int16 g_b11_1;

  _int16 b00;
  _int16 b01;
  _int16 b10;
  _int16 b11;
  unsigned _int16 i;
  unsigned _int16 u_16bit, v_16bit;
  signed _int16 rx1, ry1;
  signed _int16 sx, sy;
  signed long u1, v1, u2, v2;

  signed long a, b;
  //Inner loop for the scan line. "Num_Pix" pixels will be drawn.
  for (i = 0; i < Num_Pix; i++)
    {
      //Convert the u and v parameters from 10.22 to 8.8 format.
      u_16bit = u_init >> 14;
      v_16bit = v_init >> 14;
      //Same as Perlin's original code except floating point
      //is converted over to fixed integer.
      bx0 = u_16bit >> 8; //Obtain the integer part of the u coordinate
      bx1 = bx0 + 1;
      rx0 = u_16bit & 255; //Obtain the fractional part of the u coordinate
      rx1 = rx0 - 256;
      by0 = v_16bit >> 8;
      by1 = by0 + 1;
      ry0 = v_16bit & 255;
      ry1 = ry0 - 256;
      //Same as Perlin's original code except floating point
      //is converted over to fixed integer. The ">> 1" is used to
      //avoid overflow when the values are multiplied together.
      //This is not a problem in "C" but will be in the MMX implementation.
      sx = (((rx0 * rx0) >> 1) * ((1536 - (rx0 << 2)))) >> 16;
      sy = (((ry0 * ry0) >> 1) * ((1536 - (ry0 << 2)))) >> 16;
      //This is where the code differs from Perlins.
      //Rather than use arrays p[] and g[][], the values are
      //calculated real-time. Here random1() replaces array p[].
      //Perlin's equivalent: b00 = p[p[bx0] + by0];
      b00 = random1((random1(bx0) + by0));
      b01 = random1((random1(bx0) + by1));
      b10 = random1((random1(bx1) + by0));
      b11 = random1((random1(bx1) + by1));
      //Here, random2() replaces array g[][].
      //Perlin's equivalent: g_b00_0 = g[b00][0];
      g_b00_0 = (random2(b00) & 511) - 256;
      g_b01_0 = (random2(b01) & 511) - 256;
      g_b10_0 = (random2(b10) & 511) - 256;
      g_b11_0 = (random2(b11) & 511) - 256;
      g_b00_1 = (random2((b00 + 1)) & 511) - 256;
      g_b01_1 = (random2((b01 + 1)) & 511) - 256;
      g_b10_1 = (random2((b10 + 1)) & 511) - 256;
      g_b11_1 = (random2((b11 + 1)) & 511) - 256;
      //Same as Perlin's original code
      u1 = rx0 * g_b00_0 + ry0 * g_b00_1;
      v1 = rx1 * g_b10_0 + ry0 * g_b10_1;
      a = u1 + sx * ((v1 - u1) >> 8);
      //Same as Perlin's original code
      u2 = rx0 * g_b01_0 + ry1 * g_b01_1;
      v2 = rx1 * g_b11_0 + ry1 * g_b11_1;
      b = u2 + sx * ((v2 - u2) >> 8);
      //Same as Perlin's original code except the output is
      //converted from fixed point to regular integer. Also
      //since the output ranges from -256 to +256, a 256 offest
      //is added to make the range from 0 to 511. This offset
      //is the 65536 value. Then the 0 to 511 is scaled down.
      //to a range of 0 to 255.

      color = (a + 65536 + sy * ((b - a) >> 8)) >> 9;
      *(screen_buffer) = palette[color];
      u_init += du; // New u for calc the color of the next pixel
      v_init += dv; // New v for calc the color of the next pixel
      du += ddu; // New du for calc the color of the next pixel
      dv += ddv; // New dv for calc the color of the next pixel
      screen_buffer++; // Advance 1 word
    } // End of the scanline - repeat for next pixel
} // C_Noise()

int main() {

long u_init = 3;
long v_init = 5;
long du = 7;
long dv = 11;
long ddu = 13;
long ddv = 17;
		             unsigned _int16 Num_Pix = NUM_PIXEIS;

		             //unsigned _int16* palette;
//		             unsigned _int16 palette[256];
//             		unsigned _int16 screen_buffer[256];
             //unsigned _int16* screen_buffer;

		C_Noise(u_init, v_init, du, dv, ddu, ddv,
		             Num_Pix, palette,
             screen_buffer);

	return 0;
}
