//===-- HMCVEXISelDAGToDAG.h - Top-level interface for HMCVEX representation ----*- C++ -*-===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
//  This file defines an instruction selector for the HMCVEX Target
//
//===----------------------------------------------------------------------===//

#ifndef HMCVEXISELDAGTODAG_H
#define HMCVEXISELDAGTODAG_H


#include "HMCVEX.h"
#include "HMCVEXSubtarget.h"
#include "HMCVEXTargetMachine.h"
#include "llvm/CodeGen/SelectionDAGISel.h"
#include "llvm/IR/Type.h"
#include "llvm/Support/Debug.h"

#include "llvm/Support/ErrorHandling.h"
#include "llvm/Support/raw_ostream.h"

//===----------------------------------------------------------------------===//
// Instruction Selector Implementation
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// HMCVEXDAGToDAGISel - HMCVEX specific code to select HMCVEX machine
// instructions for SelectionDAG operations.
//===----------------------------------------------------------------------===//

namespace llvm{

#define DEBUG_TYPE "HMCVEX-isel-h"

class HMCVEXDAGToDAGISel : public SelectionDAGISel {
public:
    explicit HMCVEXDAGToDAGISel(HMCVEXTargetMachine &TM)
        : SelectionDAGISel(TM), Subtarget(nullptr){
        DEBUG(errs() << "Creating the debug message\n\n");
        }

    const char *getPassName() const override{
        DEBUG(errs() << "HMCVEX DAG->DAG Pattern Instruction Selection\n\n");
        return "HMCVEX DAG->DAG Pattern Instruction Selection";
    }

    bool runOnMachineFunction(MachineFunction &MF) override;

protected:
    SDNode *getGlobalBaseReg();

    // Keep a pointer to the HMCVEXSubtarget around so that we can make
    // the right decision when generating code for different targets.
    const HMCVEXSubtarget *Subtarget;

private:
    // Include the pieces autogenerated from the target description.
#include "HMCVEXGenDAGISel.inc"

    // getTargetMachine - Return a reference to the TargetMachine, casted
    // to the target-specific type;
    const HMCVEXTargetMachine &getTargetMachine(){
        return static_cast<const HMCVEXTargetMachine &>(TM);
    }

    SDNode *Select(SDNode *Node) override;

    std::pair<bool, SDNode*> selectNode(SDNode *Node);

    // Complex Pattern for the Load and Store Address Calculation
    bool SelectAddr(SDValue Addr, SDValue &Base, SDValue &Offset);

    // getImm - Return a target constant with the specified value;
    inline SDValue getImm(const SDNode *Node, unsigned Imm){
        return CurDAG->getTargetConstant(Imm, SDLoc(Node), Node->getValueType(0));
    }

    void processFunctionAfterISel(MachineFunction &MF);

};

FunctionPass *createHMCVEXISelDag(HMCVEXTargetMachine &TM);

}





#endif
