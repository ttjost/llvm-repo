//===-------- HMCVEXSubtarget.h - HMCVEX Subtarget  -------------------*- C++ -*-===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//

#ifndef HMCVEXSUBTARGET_H
#define HMCVEXSUBTARGET_H

#include "HMCVEXFrameLowering.h"
#include "HMCVEXISelLowering.h"
#include "HMCVEXInstrInfo.h"
#include "HMCVEXSelectionDAGInfo.h"
#include "llvm/IR/DataLayout.h"
#include "llvm/MC/MCInstrItineraries.h"
#include "llvm/Target/TargetSubtargetInfo.h"
#include <string>
#include <memory>


#define GET_SUBTARGETINFO_HEADER
//#include "HMCVEXSubtargetInfo.cpp"
#include "HMCVEXGenSubtargetInfo.inc"

namespace llvm{

struct BBsInfo {
    std::map<StringRef, unsigned> BBInfo;
    std::map<StringRef, unsigned> numberOfNodes;
};
    
class StringRef;

class HMCVEXTargetMachine;

    class HMCVEXSubtarget : public HMCVEXGenSubtargetInfo {
        
    public:
        
        enum HMCVEXABIEnum{
            ABI32
        };
        
    protected:
        enum HMCVEXArchEnum{
            rHMCVEX_2issue,
            rHMCVEX_4issue,
            rHMCVEX_8issue,
            rHMCVEX_generic,
            simple_2issue,
            simple_4issue,
            simple_8issue
        };
        
        HMCVEXArchEnum HMCVEXArchVersion;
        
        HMCVEXABIEnum HMCVEXABI;
        
        unsigned AllocationOrder;
        
        // Tells whether is the new Scheduling Algorithm to be used
        // Used for my dissertation (Tiago)
        bool isNewScheduling;
        bool EnableVLIWScheduling;

        InstrItineraryData InstrItins;
        
        // Relocation Model
        Reloc::Model RM;
        
        Triple TargetTriple;
        
        const HMCVEXSelectionDAGInfo TSInfo;
        
        HMCVEXInstrInfo InstrInfo;
        HMCVEXFrameLowering FrameLowering;
        HMCVEXTargetLowering TLInfo;

        // Measure the height of each BB
        std::unique_ptr<BBsInfo> OptBBHeights;
        std::unique_ptr<BBsInfo> SchedBBHeights;

//        HMCVEXTargetMachine &TM;
        
    public:

        BBsInfo* getOptBBHeights() const {
            OptBBHeights.get();
        }

        BBsInfo* getSchedBBHeights() const {
            SchedBBHeights.get();
        }

        unsigned getTargetABI() const { return HMCVEXABI; }
        
        ///This constructor initializes the data members to match that
        /// of the specified triple
        HMCVEXSubtarget(const Triple &TT, const std::string &CPU,
                     const std::string &FS, bool little, bool EnableVLIWScheduling,
                     Reloc::Model _RM, HMCVEXTargetMachine &_TM);

        
        //- Virtual function, must have
        // ParseSubtargetFeatures - Parses features string settin specified
        // subtarget options. Definition of function is auto generated by tblgen
        void ParseSubtargetFeatures(StringRef CPU, StringRef FS);
        
        bool isrHMCVEX_2Issue() const { return HMCVEXArchVersion == rHMCVEX_2issue; }
        bool isrHMCVEX_4Issue() const { return HMCVEXArchVersion == rHMCVEX_4issue; }
        bool isrHMCVEX_8Issue() const { return HMCVEXArchVersion == rHMCVEX_8issue; }
        bool isSimple_2Issue() const { return HMCVEXArchVersion == simple_2issue; }
        bool isSimple_4Issue() const { return HMCVEXArchVersion == simple_4issue; }
        bool isSimple_8Issue() const { return HMCVEXArchVersion == simple_8issue; }
        
        const InstrItineraryData *getInstrItineraryData() const { return &InstrItins; }

        const
        unsigned RotateRegisterOrder() const {
//            AllocationOrder = (AllocationOrder + 1)%2;
            return AllocationOrder;
        }
        
        bool abiUsesSoftFloat() const;
        
        // FIXME : Why is StackAlignment 8 ????
        //unsigned stackAlignment() const {   return 8;   }
        unsigned stackAlignment() const {   return 32;   }
        
        HMCVEXSubtarget &initializeSubtargetDependencies(StringRef CPU,
                                                      StringRef FS);
        
        const HMCVEXSelectionDAGInfo *getSelectionDAGInfo() const { return &TSInfo; }
        
        const HMCVEXInstrInfo *getInstrInfo() const { return &InstrInfo; }
        
        const TargetFrameLowering *getFrameLowering() const {
            return &FrameLowering;
        }
        
        const HMCVEXRegisterInfo *getRegisterInfo() const override {
            return &InstrInfo.getRegisterInfo();
        }
        
        const HMCVEXTargetLowering *getTargetLowering() const override { return &TLInfo; }

        bool enableMachineScheduler() const override;
        
        // We need to disable the Default Scheduler
        // If we don't do that, poor VLIW Code is generated
        bool enableMachineSchedDefaultSched() const override { return false; }
        
//        bool enablePostRAScheduler() const override {
//            return true;
//        }
//        bool enablePostMachineScheduler() const override { return true; }
        
    };
}

#endif

